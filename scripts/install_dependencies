#!/bin/bash
set -e  # Exit immediately if a command exits with a non-zero status

# Install nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.4/install.sh | bash
export NVM_DIR="$HOME/.nvm"
source "$NVM_DIR/nvm.sh"

# Install Node.js (Amazon Linux 2023 uses dnf, no amazon-linux-extras)
nvm install 18
nvm use 18

# Remove the prefix option to avoid npm conflicts
nvm use --delete-prefix v18 || true

# Create working directory if it doesn't exist
DIR="/home/root/acebook-es"
[ ! -d "$DIR" ] && echo "Creating ${DIR} directory" && mkdir -p "$DIR" || echo "${DIR} exists"

# Install EPEL repository (No amazon-linux-extras in AL2023)
sudo dnf install -y epel-release

# Install OpenSSL compatibility package (Amazon Linux 2023 no longer has compat-openssl10)
sudo dnf install -y openssl

# Remove any previous MongoDB repository file
sudo rm -f /etc/yum.repos.d/mongodb-org-*.repo

# Add MongoDB 6.0 repository (Compatible with AL2023)
echo "[mongodb-org-6.0]
name=MongoDB Repository
baseurl=https://repo.mongodb.org/yum/amazon/2023/mongodb-org/6.0/x86_64/
gpgcheck=1
enabled=1
gpgkey=https://www.mongodb.org/static/pgp/server-6.0.asc" | sudo tee /etc/yum.repos.d/mongodb-org-6.0.repo

# Import the MongoDB public GPG key
sudo rpm --import https://www.mongodb.org/static/pgp/server-6.0.asc

# Install MongoDB
sudo dnf install -y mongodb-org --setopt=install_weak_deps=False --skip-broken

# Start and enable MongoDB service
sudo systemctl enable --now mongod

# Check MongoDB status
sudo systemctl status mongod --no-pager
